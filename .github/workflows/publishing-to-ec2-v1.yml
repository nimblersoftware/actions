name: Publicação para EC2

on:
  workflow_call:
    inputs:
      DOCKER_FILE:
        required: true
        type: string
      PATH_PROJECT:
        required: true
        type: string
      CONFIG_FILE:
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
          required: true
      AWS_REGION:
          required: true
      AWS_SECRET_ACCESS_KEY:
          required: true
      DOTNET_VERSION:
          required: true
      ECR_IMAGE:
          required: true
      VERSION_SUFFIX:
        required: true
      AWS_ORGANIZATION:
          required: true
      AWS_SERVER:
        required: true
      AWS_SERVER_USER:
          required: true
      AWS_SSH_KEY:
          required: true

jobs:
  # push_to_ecr:
  #   uses: nimblersoftware/actions/.github/workflows/publishing-to-ecr-v1.yml@master
  #   with:
  #     DOCKER_FILE: ${{ inputs.DOCKER_FILE }}
  #     PATH_PROJECT: ${{ inputs.PATH_PROJECT }}
  #     CONFIG_FILE: ${{ inputs.CONFIG_FILE }}
  #   secrets:
  #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #     AWS_REGION: ${{ secrets.AWS_REGION }}
  #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #     DOTNET_VERSION: ${{ secrets.DOTNET_VERSION }}
  #     ECR_IMAGE: ${{ secrets.ECR_IMAGE }}
  #     VERSION_SUFFIX: ${{ secrets.VERSION_SUFFIX }}

  deploy:
    name: Publicação AWS EC2
    runs-on: ubuntu-latest
    # needs: push_to_ecr
    steps:
      - name: Efetuando publicação
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_SERVER }}
          username: ${{ secrets.AWS_SERVER_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            cd docker-compose
            sudo aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${{ secrets.AWS_ORGANIZATION }}
            sudo docker-compose -f docker-compose-ambiente.yml down
            sudo docker rmi $(docker images -a -q)
            sudo docker-compose -f docker-compose-ambiente.yml up -d